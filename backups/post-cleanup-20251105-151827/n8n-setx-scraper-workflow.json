{
  "name": "SETX Events Scraper - Automated Daily",
  "nodes": [
    {
      "parameters": {
        "triggerTimes": [
          {
            "mode": "everyDay",
            "hour": 0,
            "minute": 0
          }
        ]
      },
      "id": "cron-trigger",
      "name": "Trigger Daily at Midnight",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "venues",
              "value": "[{\"id\":1,\"name\":\"Julie Rogers Theatre\",\"website\":\"https://www.julierogerstheatre.com\",\"city\":\"Beaumont\"},{\"id\":2,\"name\":\"The Logon Cafe\",\"website\":\"https://logoncafe.net\",\"city\":\"Beaumont\"},{\"id\":3,\"name\":\"Lamar University\",\"website\":\"https://www.lamar.edu\",\"city\":\"Beaumont\"}]"
            }
          ]
        }
      },
      "id": "set-venues",
      "name": "Load Venues to Scrape",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "mode": "each",
        "expression": "{{ $json.venues }}"
      },
      "id": "loop-venues",
      "name": "Loop Through Each Venue",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.website }}",
        "options": {}
      },
      "id": "fetch-venue-website",
      "name": "Scrape Venue Website",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 300],
      "onError": "continueOnError"
    },
    {
      "parameters": {
        "jsCode": "// Extract events from HTML\nconst cheerio = require('cheerio');\nconst $ = cheerio.load($input.first().binary.data);\n\nconst events = [];\n\n// Look for common event patterns\n$('[class*=\"event\"], [class*=\"Event\"], article, .post').each((i, elem) => {\n  const title = $(elem).find('h2, h3, .title, .event-title').text().trim();\n  const dateStr = $(elem).find('[class*=\"date\"], time').text().trim();\n  const description = $(elem).find('p, .description').text().trim().substring(0, 200);\n  const url = $(elem).find('a').attr('href');\n\n  if (title && title.length > 3) {\n    events.push({\n      title,\n      date: dateStr || '2025-11-15',\n      time: 'TBD',\n      location: '',\n      city: $input.first().json.city,\n      category: 'Community Event',\n      description: description || 'Event from venue website',\n      source_url: url || $input.first().json.website\n    });\n  }\n});\n\nreturn {\n  venue_id: $input.first().json.id,\n  venue_name: $input.first().json.name,\n  events_found: events.length,\n  events: events.slice(0, 10) // Limit to 10 per venue\n};"
      },
      "id": "parse-events",
      "name": "Parse Events from HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300],
      "onError": "continueOnError"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3003/api/validate-batch",
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": "={{ JSON.stringify($input.first().json.events) }}",
        "options": {}
      },
      "id": "validate-events",
      "name": "Validate Events (Cloud)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1250, 300],
      "onError": "continueOnError"
    },
    {
      "parameters": {
        "url": "http://localhost:3004/mcp/claude/research-batch-images",
        "method": "POST",
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "body": "={{ JSON.stringify(($input.first().json.approved || []).map(e => ({title: e.title, venue_name: $input.previous().json.venue_name, source_url: e.source_url}))) }}",
        "options": {}
      },
      "id": "research-images",
      "name": "Research Event Images (MCP)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 300],
      "onError": "continueOnError"
    },
    {
      "parameters": {
        "loopOver": "={{ $input.first().json.results || [] }}",
        "resource": "event",
        "operation": "create",
        "title": "={{ $item.json.title }}",
        "date": "={{ $item.json.date }}",
        "time": "={{ $item.json.time || 'TBD' }}",
        "location": "={{ $item.json.location || '' }}",
        "city": "={{ $input.previous(2).json.city }}",
        "category": "={{ $item.json.category || 'Community Event' }}",
        "description": "={{ $item.json.description }}",
        "source_url": "={{ $item.json.source_url }}",
        "image_url": "={{ $item.json.imageUrls ? $item.json.imageUrls[0] : null }}",
        "price": "={{ $item.json.price }}",
        "ticket_url": "={{ $item.json.ticket_url }}",
        "age_restriction": "={{ $item.json.age_restriction }}"
      },
      "id": "save-events",
      "name": "Save Events to Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300],
      "method": "POST",
      "url": "http://localhost:3001/api/events",
      "headerParameters": {
        "parameters": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ]
      },
      "body": "={{ JSON.stringify({title: $item.json.title, date: $item.json.date, time: $item.json.time, location: $item.json.location, city: $input.previous(2).json.city, category: $item.json.category, description: $item.json.description, source_url: $item.json.source_url, image_url: $item.json.imageUrls ? $item.json.imageUrls[0] : null, price: $item.json.price, ticket_url: $item.json.ticket_url, age_restriction: $item.json.age_restriction}) }}",
      "onError": "continueOnError"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:3001/api/admin/stats"
      },
      "id": "get-stats",
      "name": "Get Final Statistics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Log completion\nconst stats = $input.first().json;\nreturn {\n  status: 'SCRAPING COMPLETE',\n  timestamp: new Date().toISOString(),\n  totalEvents: stats.totalEvents,\n  upcomingEvents: stats.upcomingEvents,\n  activeVenues: stats.activeVenues,\n  message: `âœ… Scraping finished. ${stats.upcomingEvents} upcoming events in system.`\n};"
      },
      "id": "log-complete",
      "name": "Log Completion",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 300]
    }
  ],
  "connections": {
    "cron-trigger": {
      "main": [
        [
          {
            "node": "set-venues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set-venues": {
      "main": [
        [
          {
            "node": "loop-venues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "loop-venues": {
      "main": [
        [
          {
            "node": "fetch-venue-website",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch-venue-website": {
      "main": [
        [
          {
            "node": "parse-events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parse-events": {
      "main": [
        [
          {
            "node": "validate-events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validate-events": {
      "main": [
        [
          {
            "node": "research-images",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "research-images": {
      "main": [
        [
          {
            "node": "save-events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save-events": {
      "main": [
        [
          {
            "node": "get-stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-stats": {
      "main": [
        [
          {
            "node": "log-complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  }
}
